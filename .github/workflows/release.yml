# This workflow creates a signed .xpi file for Thunderbird and attaches it to a GitHub Release.
# It is triggered automatically whenever a new tag in the form of 'v*.*.*' (e.g., v1.0.0) is pushed.

name: Create Thunderbird Release

on:
  push:
    tags:
      - 'v*.*.*' # Runs on tags like v1.0.0, v1.2.3, etc.

jobs:
  build-and-sign:
    runs-on: ubuntu-latest

    steps:
      # 1. Check out the repository's code
      - name: Checkout code
        uses: actions/checkout@v4

      # 2. Set up Node.js, which is needed to run web-ext
      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      # 3. Install web-ext, the command-line tool for managing WebExtensions
      - name: Install web-ext
        run: npm install --global web-ext

      # 4. Create a source .zip file containing only the necessary add-on files.
      #    This is for users who want to inspect the source code for this release.
      - name: Package add-on source
        run: zip -r source.zip manifest.json background/ icons/ README.md LICENSE updates.json .github/

      # 5. Sign the add-on using Thunderbird's Add-on servers.
      #    It uses the API keys stored as GitHub secrets.
      #    The --channel=listed flag is for public releases on ATN.
      #    web-ext v8+ automatically detects the correct API endpoint for Thunderbird.
      - name: Sign add-on
        run: >
          web-ext sign
          --api-key ${{ secrets.ATN_JWT_ISSUER }}
          --api-secret ${{ secrets.ATN_JWT_SECRET }}
          --channel=listed

      # 6. Create a GitHub Release and attach the signed .xpi and source.zip files.
      #    This makes it easy to download the final, installable file.
      - name: Create GitHub Release and Upload Artifacts
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ github.ref_name }}
          name: ${{ github.ref_name }}
          files: |
            web-ext-artifacts/*.xpi
            source.zip
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}